<!DOCTYPE html>
  <html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>指數基金計算</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <style>
      .container {
        max-width: 1440px;
        margin: 24px auto;
        padding: 24px;
      }
      .column {
        float: left;
        width: 50%;
      }
      .row:after {
        content: "";
        display: table;
        clear: both;
      }
      table {
        width: 100%;
     }
     th, td {
        text-align: left;
     }
     label {
        cursor: pointer;
     }
     input{
        margin: 5px 2px;
        padding: 3px 5px;
        border: none;
        /* border-bottom: 1px solid darkgrey; */
        background-color: rgb(247, 247, 247);
     }
     button {
        cursor: pointer;
     }
  </style>
  <body>
    <div class="container" id="container">
      <h1 style="color: grey;text-align: center;">指數基金計算</h1>
      <div>
        <form id="frm">
        <h2>資金投入</h2>
        <a style="color:rgb(175, 175, 175);">*至少填任一項*</a><p>
        <label for="start">初始投資</label><br>
        $ <input type="number" id="start" min="0" step="100"><p>

        <label for="limited">限期月定投</label><br>
        $ <input type="number" id="limited" min="0" step="100">&nbsp
        持續 <input type="number" id="limitedY" min="0" max="60"><label for="limitedY"> 年 </label>
        <input type="number" id="limitedM" min="0" max="11"><label for="limitedM"> 個月</label>
        <p>

        <label for="continuous">持續月定投</label><br>
        $ <input type="number" id="continuous" min="0" step="100">
        <ul>
            <li style="color: grey;">
                如果會定期增加，每 <input type="number" id="continuousGrowY" style="color: grey;" min="0" max="60"><label for="continuousGrowY"> 年</label>，月投額增加
                <label for="continuousGrow"> $ </label><input type="number" id="continuousGrow" style="color: grey;" min="0"> 或 
                <input type="number" id="continuousGrowPer" style="color: grey;" min="0" max="1000"><label for="continuousGrowPer"> %</label>
            </li>
        </ul><p><br>
        <h2>期間與基金配比</h2>
        <a style="color:rgb(175, 175, 175);">*沒有特別需求可以無視第二階段，配比IWDA直接填100*</a><br>
        <div class="column">
            <h4>第一階段</h4>
                <label for="years1">投資年期：</label>
                <input type="number" id="years1" min="1" max="60"><p>
                配比<p>
                <label for="IWDA1">IWDA </label><input type="number" id="IWDA1" value="100" min="0" max="100" step="10"> %
                <!-- <button type="button" onclick="fillPercentage('IWDA1', 100)">100%</button> -->
                <p>
                <label for="VOO1">VOO </label><input type="number" id="VOO1" min="0" max="100" step="10"> %<p>
                <label for="QQQM1">QQQM </label><input type="number" id="QQQM1" min="0" max="100" step="10"> %<p>
        </div>

        <div class="column">
            <h4>第二階段</h4>
                 <label for="years2">投資年期：</label>
                <input type="number" id="years2" min="1" max="60"><p>
                配比<p>
                <label for="IWDA2">IWDA </label><input type="number" id="IWDA2" min="0" max="100" step="10"> %<p>
                <label for="VOO2">VOO </label><input type="number" id="VOO2" min="0" max="100" step="10"> %<p>
                <label for="QQQM2">QQQM </label><input type="number" id="QQQM2" min="0" max="100" step="10"> %<p>
        </div>
        </form>
        <div style="padding:20px 0px;">
            <a style="color: rgb(175, 175, 175);">*輸入太快按「計算」可能會導致出現錯誤警告或空缺結果，重新填寫後再計算即可。</a><p>
            <button onclick="calculate()" style="padding: 12px 200px;font-size: 16px;">計算</button>
            <button onclick="clean()" style="padding: 12px 50px;font-size: 16px;float:right;">重設</button><p></p>
        </div>

        <p><div id="modeButton"></div></p>
        
        <div>
            <div class="column" id="table1"></div>
            <canvas class="column" id="graph1"></canvas>
        </div><p>
        
        <div>
            <div class="column" id="table2"></div>
            <canvas class="column" id="graph2"></canvas>
        </div><p>

        <div id="cap"></div>
      </div>
    </div>
  </body>
  <script>
    function numberWithCommas(x) {
        return x.toLocaleString('zh-Hant', {maximumFractionDigits: 0});
    }

    let mode = 1;

    function calculate() {
        // 添加一個小延遲，確保輸入事件已經完成
        setTimeout(() => {
            
        const IWDA_R = [0.08, 0.09, 0.11], VOO_R = [0.1, 0.12, 0.15], QQQM_R = [0.1, 0.15, 0.17];

        const fields = [
            'start', 'limited', 'limitedY', 'limitedM', 'continuous', 'continuousGrowY', 
            'continuousGrow', 'continuousGrowPer', 'years1', 'IWDA1', 
            'VOO1', 'QQQM1', 'years2', 'IWDA2', 'VOO2', 'QQQM2'
        ];

        fields.forEach(field => {
            const element = document.getElementById(field);
            element.value = parseFloat(localStorage.getItem(`${field}_`)) || '';
        
            element.addEventListener('input', () => {
                localStorage.setItem(`${field}_`, element.value);
            });
        });

        // 確保所有數值都正確轉換
        const start = parseFloat(document.getElementById('start').value) || 0;
        const limited = parseFloat(document.getElementById('limited').value) || 0;
        const limitedY = parseFloat(document.getElementById('limitedY').value) || 0;
        const limitedM = parseFloat(document.getElementById('limitedM').value) || 0;
        const continuous = parseFloat(document.getElementById('continuous').value) || 0;
        const continuousGrowY = parseFloat(document.getElementById('continuousGrowY').value) || 0;
        const continuousGrow = parseFloat(document.getElementById('continuousGrow').value) || 0;
        const continuousGrowPer = parseFloat(document.getElementById('continuousGrowPer').value) || 0;
        const years1 = parseFloat(document.getElementById('years1').value) || 0;
        const years2 = parseFloat(document.getElementById('years2').value) || 0;
        const IWDA1 = parseFloat(document.getElementById('IWDA1').value) || 0;
        const VOO1 = parseFloat(document.getElementById('VOO1').value) || 0;
        const QQQM1 = parseFloat(document.getElementById('QQQM1').value) || 0;
        const IWDA2 = parseFloat(document.getElementById('IWDA2').value) || 0;
        const VOO2 = parseFloat(document.getElementById('VOO2').value) || 0;
        const QQQM2 = parseFloat(document.getElementById('QQQM2').value) || 0;

        let totalYears = years1 + years2;
        let period = 0;
        
        const yearRate = [];
        yearRate[0] = IWDA_R[mode] * IWDA1/100 + VOO_R[mode] * VOO1/100 + QQQM_R[mode] * QQQM1/100;
        yearRate[1] = IWDA_R[mode] * IWDA2/100 + VOO_R[mode] * VOO2/100 + QQQM_R[mode] * QQQM2/100;
        
        const limitedYearly = [];
        const amount = [], principal = [], yearly = [], yreturn = [], maverage = [];

        const continuousYearly = [];

        // 計算每年限期月定投
        for (let i = 0; i <= limitedY; i++) {
            if (i === limitedY && limitedM > 0) { // 計算月份
                limitedYearly[i] = limited * limitedM;
            } else if (i < limitedY) {
                limitedYearly[i] = limited * 12;
                // limitedYearly[i] = parseFloat(limitedYearly[i]);
            }
        }

        // 計算每年持續月定投
        for (let i = 0; i < totalYears; i++) {
            if (i === 0) {
                continuousYearly[i] = continuous * 12;
            } else {
                if (continuousGrowY > 0 && (i+1) % continuousGrowY === 0) { //如果有增長
                    if (continuousGrow > 0) {
                        continuousYearly[i] = continuousYearly[i-1] + continuousGrow*12;
                    } else {
                        continuousYearly[i] = continuousYearly[i-1] * (1+continuousGrowPer/100);
                    }
                } else {
                    continuousYearly[i] = continuousYearly[i-1];
                }
            }
        }

        for (let i = 0; i < totalYears; i++) {
            if (i === years1) {
                period = 1;
            }
            if (i === 0) {
                if (limitedYearly[i] > 0) { // 如果有限期月定投
                    yearly[i] = start + limitedYearly[i] + continuousYearly[i];
                } else {
                    yearly[i] = start + continuousYearly[i];
                }
                // yearly[i] = start + limitedYearly[i] + continuousYearly[i];
                amount[i] = yearly[i] * (1 + yearRate[0]);
                principal[i] = yearly[i];
                yreturn[i] = amount[i] - principal[i];
            } else {
                if (limitedYearly[i] > 0) { // 如果有限期月定投
                    yearly[i] = limitedYearly[i] + continuousYearly[i];
                } else {
                    yearly[i] = continuousYearly[i];
                }
                amount[i] = (amount[i-1] + yearly[i]) * (1 + yearRate[period]);
                principal[i] = principal[i-1] + yearly[i];
                yreturn[i] = amount[i] - amount[i-1];
            }
            maverage[i] = yreturn[i] / 12;
        }

        if (years1 === 0 && (limited === 0 && continuous === 0) && (IWDA1 === 0 && VOO1 === 0 && QQQM1 === 0)) {
            alert("「投資年期」、「限期月定投」或「持續月定投」、「配比」必須填寫。");
            return;
        } else if (IWDA1 + VOO1 + QQQM1 != 100) {
            alert("「配比」加起來必須是100%。");
            return;
        }
        if (limited > 0) {
            if ((limitedY === 0 && limitedM === 0)) {
                alert("「限期月定投必須填寫「期限」。");
                return;
            } else if (limitedY > totalYears || (limitedY === totalYears && limitedM > 0)) {
                alert("「限期月定投期限不能大於「全投資年期」。");
                return;
            }
        }
        if ((limitedY > 0 || limitedM > 0) && limited === 0) {
            alert("「限期月定投」尚未填寫「金額」。");
            return;
        }
        if (continuousGrowY > 0) {
            if (continuousGrow > 0 && continuousGrowPer > 0) {
                alert("「月投額增長」只能填寫「金額」或者「百分比」。");
                return;
            } else if (continuousGrow === 0 && continuousGrowPer === 0) {
                alert("「月投額增長」必須填寫填「金額」或者「百分比」。");
                return;
            }
        }
        if (continuousGrow > 0 || continuousGrowPer > 0) {
            if (continuousGrowY === 0) {
                alert("「月投額增長」未填寫「頻率」。");
                return;
            } else if (continuousGrowY > totalYears) {
                alert("「月投額增長頻率」大於「總投資年期」。");
                return;
            }
        }
        if (years2 > 0) {
            if (IWDA2 === 0 && VOO2 === 0 && QQQM2 === 0) {
                alert("「第二階段」未填寫「配比」。");
                return;
            } else if (IWDA2 + VOO2 + QQQM2 != 100) {
                alert("「第二階段」「配比」加起來必須是100%。");
                return;
            }
        }
        if ((IWDA2 > 0 || VOO2 > 0 || QQQM2 > 0) && years2 === 0) {
            alert("「第二階段」未填寫「投資年期」。");
            return;
        }

        let modeButton = `
            <button onclick="setMode(0)" style="border: none;padding: 8px 90px;font-size: 12;">保守</button>
            <button onclick="setMode(1)" style="border: none;padding: 8px 90px;font-size: 12;">一般</button>
            <button onclick="setMode(2)" style="border: none;padding: 8px 90px;font-size: 12;">進取</button>
        `;

        const modeStr = ["保守", "一般", "進取"];

        let table1 = `
            ${modeStr[mode]} 年利率 ${yearRate[0].toFixed(2)*100} %<p>
            <table>
            <tr>
                <th></th>
                <th>總額</th>
                <th>本金</th>
                <th>年度投入</th>
                <th>年回報<a style="color:grey;">（月均）</a></th>
            </tr>
        `;

        const graph1 = document.getElementById("graph1");
        graph1.height = years1 * 13 + 40;

        const g1 = graph1.getContext("2d");
        g1.fillStyle = 'white';
        g1.fillRect(0, 0, graph1.width, graph1.height);
        g1.fillStyle="grey";
        g1.fillRect(200,20,5,5);
        g1.fillStyle="grey";
        g1.font = "8px Arial";
        g1.fillText("總額", 210, 26);

        g1.fillStyle="black";
        g1.fillRect(200,35,5,5);
        g1.fillStyle="black";
        g1.font = "8px Arial";
        g1.fillText("本金", 210, 41);

        for (let i = 0; i < years1; i++) {
            table1 += `
                <tr>
                    <td>第${i+1}年</td>
                    <td>$ ${amount[i].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}</td>
                    <td>$ ${principal[i].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}</td>
                    <td>$ ${yearly[i].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}</td>
                    <td>$ ${yreturn[i].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}<a style="color:grey;">（$ ${maverage[i].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}）</a></td>
                </tr>
            `;
            g1.beginPath();
            g1.moveTo(0, i*10.515+30);
            g1.lineTo(graph1.width*(amount[i]/amount[totalYears-1]), i*10.515+30)
            g1.strokeStyle = "grey";
            g1.lineWidth = 3;
            g1.stroke();
            g1.beginPath();
            g1.moveTo(0, i*10.515+30);
            g1.lineTo(graph1.width*(amount[i]/amount[totalYears-1])*(principal[i]/amount[i]), i*10.515+30)
            g1.strokeStyle = "black";
            g1.lineWidth = 3;
            g1.stroke();
        }
        
        table1 += `</table>`;
        

        let table2 = "";

        const graph2 = document.getElementById("graph2");
        graph2.height = years2 * 13 + 30;
        const g2 = graph2.getContext("2d");

        if (years2 > 0) { //如果有第二階段
            g2.fillStyle = 'white';
            g2.fillRect(0, 0, graph2.width, graph2.height);
            table2 = `
                ${modeStr[mode]} 年利率 ${yearRate[1].toFixed(2)*100} %<p>
                <table>
                <tr>
                    <th></th>
                    <th>總額</th>
                    <th>本金</th>
                    <th>年度投入</th>
                    <th>年回報<a style="color:grey;">（月均）</a></th>
                </tr>
            `;
            for (let i = 0; i < years2; i++) {
                table2 += `
                    <tr>
                        <td>第${i+1+years1}年</td>
                        <td>$ ${amount[i+years1].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}</td>
                        <td>$ ${principal[i+years1].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}</td>
                        <td>$ ${yearly[i+years1].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}</td>
                        <td>$ ${yreturn[i+years1].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}<a style="color:grey;">（$ ${maverage[i+years1].toLocaleString('zh-Hant', {maximumFractionDigits: 0})}）</a></td>
                    </tr>
                `;
                g2.beginPath();
                g2.moveTo(0, i*10.515+30);
                g2.lineTo(graph1.width*(amount[i+years1]/amount[totalYears-1]), i*10.515+30)
                g2.strokeStyle = "grey";
                g2.lineWidth = 3;
                g2.stroke();
                g2.beginPath();
                g2.moveTo(0, i*10.515+30);
                g2.lineTo(graph1.width*(amount[i+years1]/amount[totalYears-1])*(principal[i+years1]/amount[i+years1]), i*10.515+30)
                g2.strokeStyle = "black";
                g2.lineWidth = 3;
                g2.stroke();
            }
            table2 += `</table>`;
        }

        let cap = "<button onclick='capture()' style='padding:6px 20px;'>儲存圖片</button>";

        document.getElementById("modeButton").innerHTML = modeButton
        document.getElementById("table1").innerHTML = table1;
        document.getElementById("table2").innerHTML = table2;
        document.getElementById("cap").innerHTML = cap;
        }, 100); // 100毫秒的延遲
    }

    function setMode(newMode) {
        // 在 calculate() 函數中已經宣告了 mode 變數，所以這裡直接修改全域變數
        mode = newMode;
        calculate(); // 重新計算並更新表格
    }

    function capture() {
        const container = document.getElementById('container');
        // 確保 container 高度包含所有內容
        container.style.height = `${container.scrollHeight}px`;
        html2canvas(container).then(canvas => {
            const link = document.createElement('a');
            link.download = 'IndexFund.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    function clean() {
        document.getElementById("frm").reset();

        const fields = [
        'start', 'limited', 'limitedY', 'limitedM', 'continuous', 'continuousGrowY', 
        'continuousGrow', 'continuousGrowPer', 'years1', 'IWDA1', 
        'VOO1', 'QQQM1', 'years2', 'IWDA2', 'VOO2', 'QQQM2'
        ];

        // 清除每個欄位的 localStorage
        fields.forEach(field => {
            if (field === "IWDA1") {
                document.getElementById(field).value = 100;
                localStorage.setItem(`${field}_`, '100');
            } else {
                localStorage.removeItem(`${field}_`);
            }
        });

        document.getElementById(field).value = 100;
        localStorage.setItem(`${field}_`, '100');

        // 清除結果區域
        document.getElementById("modeButton").innerHTML = '';
        document.getElementById("table1").innerHTML = '';
        document.getElementById("table2").innerHTML = '';
        document.getElementById("cap").innerHTML = '';

        // 清除畫布
        const graph1 = document.getElementById("graph1");
        const graph2 = document.getElementById("graph2");
        const g1 = graph1.getContext("2d");
        const g2 = graph2.getContext("2d");
        
        g1.clearRect(0, 0, graph1.width, graph1.height);
        g2.clearRect(0, 0, graph2.width, graph2.height);
    }

    function fillPercentage(inputId, percentage) {
    const inputElement = document.getElementById(inputId);
    
    // 設置輸入框的值
    inputElement.value = percentage;
    
    // 觸發 input 事件，這樣會自動更新 localStorage
    inputElement.dispatchEvent(new Event('input'));
    
    // 如果是配比欄位，可能需要調整其他配比
    if (inputId.startsWith('IWDA') || inputId.startsWith('VOO') || inputId.startsWith('QQQM')) {
        autoAdjustPercentage(inputId, percentage);
    }
}

function autoAdjustPercentage(changedInputId, percentage) {
    // 提取階段數字（1 或 2）
    const stage = changedInputId.slice(-1);
    
    // 找到同階段的其他配比輸入框
    const otherInputIds = {
        'IWDA1': ['VOO1', 'QQQM1'],
        'VOO1': ['IWDA1', 'QQQM1'],
        'QQQM1': ['IWDA1', 'VOO1'],
        'IWDA2': ['VOO2', 'QQQM2'],
        'VOO2': ['IWDA2', 'QQQM2'],
        'QQQM2': ['IWDA2', 'VOO2']
    };

    const remainingIds = otherInputIds[changedInputId];
    
    if (percentage === 100) {
        // 如果當前輸入框設置為 100%，其他輸入框設置為 0
        remainingIds.forEach(id => {
            const otherInput = document.getElementById(id);
            otherInput.value = 0;
            otherInput.dispatchEvent(new Event('input'));
        });
    } /* else if (percentage === 0) {
        // 如果當前輸入框設置為 0，平均分配給其他輸入框
        const remainingPercentage = 100 - percentage;
        const splitPercentage = Math.floor(remainingPercentage / remainingIds.length);
        
        remainingIds.forEach((id, index) => {
            const otherInput = document.getElementById(id);
            // 最後一個輸入框調整到剩餘百分比，避免總和不是 100
            const value = (index === remainingIds.length - 1) 
                ? (remainingPercentage - splitPercentage * (remainingIds.length - 1))
                : splitPercentage;
            
            otherInput.value = value;
            otherInput.dispatchEvent(new Event('input'));
        });
    } */
}
  </script>
</html>